<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pro | Trader's Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #0b0e11; color: #e6edf3; }
        
        .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; }
        .card:hover { border-color: #79c0ff; background-color: #1c2128; transition: 0.2s; }
        
        /* Elite 5 카드 스타일 */
        .elite-card { background: linear-gradient(145deg, #0d1117 0%, #161b22 100%); border: 1px solid #2ea043; position: relative; overflow: hidden; }
        .elite-badge { position: absolute; top: 0; right: 0; background: #2ea043; color: #fff; font-weight: 800; font-size: 0.65rem; padding: 2px 8px; border-bottom-left-radius: 6px; }

        /* 가격 위치 바 (Range Bar) - 컴팩트 버전 */
        .range-track { width: 100%; height: 6px; background: #30363d; border-radius: 3px; position: relative; margin-top: 8px; }
        .current-marker { 
            position: absolute; top: -5px; width: 4px; height: 16px; background: #fff; 
            box-shadow: 0 0 6px rgba(255,255,255,0.9); z-index: 10; transform: translateX(-50%);
        }
        .price-label { font-size: 0.65rem; color: #8b949e; position: absolute; top: 14px; }
        .price-label.low { left: 0; }
        .price-label.high { right: 0; }

        .tag-ready { color: #3fb950; background: rgba(63, 185, 80, 0.15); border: 1px solid rgba(63, 185, 80, 0.4); }
        .tag-watch { color: #58a6ff; background: rgba(88, 166, 255, 0.15); border: 1px solid rgba(88, 166, 255, 0.4); }

        .hidden-row { display: none; }
        .expanded-row { background-color: #11141a; border-top: 1px dashed #30363d; border-bottom: 1px solid #30363d; }
    </style>
</head>
<body class="p-4 md:p-6 max-w-[1600px] mx-auto">

    <header class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight flex items-center text-white">
                <i class="fa-solid fa-crosshairs text-green-500 mr-3"></i>
                Turnaround Sniper
                <span class="ml-3 text-[10px] text-black bg-green-500 px-1.5 py-0.5 rounded font-bold uppercase">Pro Terminal</span>
            </h1>
        </div>
        <div class="text-right flex items-center space-x-4">
            <div id="last-update" class="text-xs font-mono text-gray-500">SYNCING...</div>
            <div class="text-xs text-green-500 font-bold px-2 py-1 bg-green-900/20 rounded border border-green-900/50"><i class="fa-solid fa-bolt mr-1"></i>Live</div>
        </div>
    </header>

    <section class="mb-8">
        <h2 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider"><i class="fa-solid fa-star text-yellow-500 mr-1"></i> Top 5 Movers</h2>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="elite-container">
            </div>
    </section>

    <main>
        <div class="flex items-center justify-between mb-3 px-1">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider"><i class="fa-solid fa-list-ul mr-1"></i> Market Scanner</h3>
            <span class="text-[10px] text-gray-600">CLICK ROW FOR ANALYSIS</span>
        </div>

        <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-[10px] text-gray-500 font-bold uppercase border-b border-gray-800">
            <div class="col-span-2">Ticker / Price</div> <div class="col-span-5 text-center">Price Position (Low vs High)</div> <div class="col-span-5">Key Issue / News Headline</div> </div>

        <div class="flex flex-col space-y-2" id="candidate-list">
            </div>
    </main>

    <script>
        async function loadDashboard() {
            try {
                const response = await fetch('data/data.json?t=' + Date.now());
                const data = await response.json();

                // 메타데이터
                document.getElementById('last-update').innerText = `UPDATED: ${data.metadata.generated_at}`;

                // 정렬 및 필터링
                let candidates = data.candidates;
                let readyStocks = candidates.filter(c => c.evidence.s4_tag === 'READY');
                if (readyStocks.length < 5) {
                    const watchStocks = candidates.filter(c => c.evidence.s4_tag === 'WATCH');
                    readyStocks = [...readyStocks, ...watchStocks];
                }
                readyStocks.sort((a, b) => b.metrics.rec_rate - a.metrics.rec_rate);
                
                // --- 1. Elite 5 렌더링 (유지) ---
                const eliteContainer = document.getElementById('elite-container');
                eliteContainer.innerHTML = '';
                
                readyStocks.slice(0, 5).forEach((stock, idx) => {
                    const price = stock.price;
                    const highPrice = price / (1 + stock.metrics.drop_rate);
                    const lowPrice = price / (1 + stock.metrics.rec_rate);
                    let posPercent = ((price - lowPrice) / (highPrice - lowPrice)) * 100;
                    posPercent = Math.max(0, Math.min(100, posPercent));

                    const html = `
                        <div class="card elite-card p-3 cursor-pointer hover:scale-[1.02] transition-transform" onclick="document.getElementById('row-${stock.ticker}').scrollIntoView({behavior: 'smooth'}); toggleRow('${stock.ticker}')">
                            <div class="elite-badge">#${idx + 1}</div>
                            <div class="flex justify-between items-end mb-2">
                                <div class="text-xl font-bold text-white">${stock.ticker}</div>
                                <div class="text-xs text-green-400 font-bold">+${(stock.metrics.rec_rate * 100).toFixed(1)}%</div>
                            </div>
                            <div class="w-full bg-gray-800 h-1 rounded-full overflow-hidden">
                                <div class="bg-green-500 h-full" style="width: ${posPercent}%"></div>
                            </div>
                            <div class="flex justify-between text-[9px] text-gray-500 mt-1">
                                <span>$${lowPrice.toFixed(1)}</span>
                                <span>$${highPrice.toFixed(1)}</span>
                            </div>
                        </div>
                    `;
                    eliteContainer.insertAdjacentHTML('beforeend', html);
                });


                // --- 2. 메인 리스트 렌더링 (지휘관님 1:2:2 요청 반영) ---
                const listContainer = document.getElementById('candidate-list');
                listContainer.innerHTML = '';

                candidates.forEach((stock) => {
                    const isReady = stock.evidence.s4_tag === 'READY';
                    const tagClass = isReady ? 'tag-ready' : 'tag-watch';
                    
                    // 가격 역산
                    const price = stock.price;
                    const highPrice = price / (1 + stock.metrics.drop_rate);
                    const lowPrice = price / (1 + stock.metrics.rec_rate);
                    let posPercent = ((price - lowPrice) / (highPrice - lowPrice)) * 100;
                    posPercent = Math.max(5, Math.min(95, posPercent));

                    // 뉴스/이유 요약 (우측 패널용)
                    // 뉴스가 너무 길면 자르고, 없으면 분석 코멘트 앞부분 사용
                    let reasonText = stock.context;
                    if (!reasonText || reasonText === "No significant news found") {
                        // 뉴스가 없으면 AI 분석의 첫 문장을 가져옴
                        reasonText = stock.evidence.analysis_kr.split('.')[0] + "."; 
                    }
                    if (reasonText.length > 85) reasonText = reasonText.substring(0, 85) + "...";

                    const itemHTML = `
                        <div id="row-${stock.ticker}" class="card overflow-hidden group">
                            <div class="p-3 cursor-pointer grid grid-cols-1 md:grid-cols-12 gap-4 items-center" onclick="toggleRow('${stock.ticker}')">
                                
                                <div class="md:col-span-2 flex items-center justify-between md:justify-start md:space-x-3">
                                    <div class="text-lg font-bold text-white w-16">${stock.ticker}</div>
                                    <div class="flex flex-col md:items-start text-right md:text-left">
                                        <div class="text-sm font-mono text-gray-300">$${price}</div>
                                        <span class="text-[9px] px-1.5 py-0.5 rounded font-bold ${tagClass}">${stock.evidence.s4_tag}</span>
                                    </div>
                                </div>

                                <div class="md:col-span-5 px-2">
                                    <div class="range-track">
                                        <div class="current-marker" style="left: ${posPercent}%"></div>
                                        <div class="price-label low">L: $${lowPrice.toFixed(1)}</div>
                                        <div class="price-label high">H: $${highPrice.toFixed(1)}</div>
                                    </div>
                                </div>

                                <div class="md:col-span-5 flex items-center justify-between pl-2">
                                    <div class="text-xs text-gray-400 line-clamp-1 group-hover:text-gray-200 transition-colors">
                                        <i class="fa-regular fa-newspaper text-gray-600 mr-2"></i>${reasonText}
                                    </div>
                                    <i id="icon-${stock.ticker}" class="fa-solid fa-chevron-down text-gray-600 text-xs ml-3 transition-transform"></i>
                                </div>
                            </div>

                            <div id="detail-${stock.ticker}" class="hidden-row p-5 bg-[#0f1218]">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="text-[10px] font-bold text-blue-400 uppercase mb-2"><i class="fa-solid fa-robot mr-1"></i> Strategy Analysis</h4>
                                        <div class="text-sm text-gray-300 leading-relaxed whitespace-pre-line border-l-2 border-blue-900/50 pl-3">
                                            ${stock.evidence.analysis_kr}
                                        </div>
                                        <div class="mt-3 text-xs text-gray-500">
                                            * Reward Potential: <span class="text-green-400 font-bold">+${((highPrice/price - 1)*100).toFixed(0)}%</span> to High
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 class="text-[10px] font-bold text-gray-500 uppercase mb-2"><i class="fa-brands fa-google mr-1"></i> News Context</h4>
                                        <div class="bg-black/40 p-3 rounded border border-gray-800 text-sm text-gray-300 mb-3">
                                            "${stock.context}"
                                        </div>
                                        <a href="https://www.google.com/search?q=${stock.ticker}+stock+news" target="_blank" 
                                           class="inline-block px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-xs text-blue-400 transition">
                                            Open Google News <i class="fa-solid fa-external-link-alt ml-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', itemHTML);
                });

            } catch (err) {
                console.error(err);
            }
        }

        function toggleRow(ticker) {
            const row = document.getElementById(`detail-${ticker}`);
            const icon = document.getElementById(`icon-${ticker}`);
            if (row.classList.contains('hidden-row')) {
                row.classList.remove('hidden-row');
                row.classList.add('expanded-row');
                icon.style.transform = 'rotate(180deg)';
            } else {
                row.classList.add('hidden-row');
                row.classList.remove('expanded-row');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        loadDashboard();
    </script>
</body>
</html>
