<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pro | Command Center V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #0b0e11; color: #e6edf3; }
        
        .card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; }
        .card:hover { border-color: #58a6ff; transition: 0.3s; }
        
        /* Elite 5 Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .elite-card { background: linear-gradient(145deg, #161b22 0%, #1c2128 100%); border: 1px solid #3fb950; position: relative; overflow: hidden; }
        .elite-badge { position: absolute; top: 0; right: 0; background: #3fb950; color: #000; font-weight: bold; font-size: 0.7rem; padding: 2px 8px; border-bottom-left-radius: 8px; }

        /* Í∞ÄÍ≤© ÏúÑÏπò Î∞î (Range Bar) Ïä§ÌÉÄÏùº */
        .range-track { width: 100%; height: 8px; background: #30363d; border-radius: 4px; position: relative; margin-top: 15px; margin-bottom: 5px; }
        .range-fill { height: 100%; background: linear-gradient(90deg, #3fb950, #2ea043); border-radius: 4px; opacity: 0.5; }
        .current-marker { 
            position: absolute; top: -6px; width: 4px; height: 20px; background: #fff; 
            box-shadow: 0 0 8px rgba(255,255,255,0.8); z-index: 10; transform: translateX(-50%);
        }
        .price-label { font-size: 0.7rem; color: #8b949e; position: absolute; top: 18px; }
        .price-label.low { left: 0; }
        .price-label.high { right: 0; }
        .price-label.current { top: -20px; color: #fff; font-weight: bold; transform: translateX(-50%); }

        .hidden-row { display: none; }
        .expanded-row { background-color: #11141a; border-top: 1px dashed #30363d; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto">

    <header class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight flex items-center text-white">
                <i class="fa-solid fa-crosshairs text-green-500 mr-3"></i>
                Turnaround Sniper
                <span class="ml-3 text-xs font-normal text-black bg-green-500 px-2 py-0.5 rounded font-bold">V3.0 ELITE</span>
            </h1>
        </div>
        <div class="text-right">
            <div id="last-update" class="text-xs font-mono text-gray-500">UPDATING...</div>
            <div class="text-xs text-green-500 font-bold"><i class="fa-solid fa-wifi mr-1"></i>Live</div>
        </div>
    </header>

    <section class="mb-12">
        <div class="flex items-center space-x-2 mb-4">
            <i class="fa-solid fa-star text-yellow-400"></i>
            <h2 class="text-lg font-bold text-white">Top 5 Elite Strategies</h2>
            <span class="text-xs text-gray-500 ml-2">Î∞òÎì± Î™®Î©òÌÖÄÏù¥ Í∞ÄÏû• Í∞ïÎ†•Ìïú ÏÉÅÏúÑ 5Í∞ú Ï¢ÖÎ™©</span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="elite-container">
            <div class="col-span-5 text-center text-gray-600 py-10">Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...</div>
        </div>
    </section>

    <main>
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-list text-gray-400"></i>
                <h3 class="text-lg font-bold text-white">All Candidates</h3>
            </div>
            <span class="text-xs text-gray-500"><i class="fa-solid fa-info-circle mr-1"></i>Î¶¨Ïä§Ìä∏Î•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏ Î∂ÑÏÑù ÌôïÏù∏</span>
        </div>

        <div class="flex flex-col space-y-3" id="candidate-list">
            </div>
    </main>

    <script>
        async function loadDashboard() {
            try {
                const response = await fetch('data/data.json?t=' + Date.now());
                const data = await response.json();

                // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('last-update').innerText = `DATA: ${data.metadata.generated_at}`;

                // Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨: READY Ï¢ÖÎ™© Ï§ë Î∞òÎì±Ìè≠(rec_rate) ÎÜíÏùÄ Ïàú Ï†ïÎ†¨
                let candidates = data.candidates;
                let readyStocks = candidates.filter(c => c.evidence.s4_tag === 'READY');
                
                // ÎßåÏïΩ READYÍ∞Ä 5Í∞ú ÎØ∏ÎßåÏù¥Î©¥ WATCHÏóêÏÑúÎèÑ Îç∞Î†§Ïò¥
                if (readyStocks.length < 5) {
                    const watchStocks = candidates.filter(c => c.evidence.s4_tag === 'WATCH');
                    readyStocks = [...readyStocks, ...watchStocks];
                }

                // Ï†ïÎ†¨ (Î∞òÎì±Î•† ÎÇ¥Î¶ºÏ∞®Ïàú)
                readyStocks.sort((a, b) => b.metrics.rec_rate - a.metrics.rec_rate);
                
                // --- 1. Elite 5 Î†åÎçîÎßÅ ---
                const eliteContainer = document.getElementById('elite-container');
                eliteContainer.innerHTML = '';
                
                readyStocks.slice(0, 5).forEach((stock, idx) => {
                    const price = stock.price;
                    const dropRate = stock.metrics.drop_rate; // ÏùåÏàò (Ïòà: -0.6)
                    const recRate = stock.metrics.rec_rate;   // ÏñëÏàò (Ïòà: 0.2)

                    // [ÌïµÏã¨] Í≥†Ï†êÍ≥º Ï†ÄÏ†ê Ïó≠ÏÇ∞ (Reverse Calculation)
                    // ÌòÑÏû¨Í∞Ä = Í≥†Ï†ê * (1 + dropRate)  -> Í≥†Ï†ê = ÌòÑÏû¨Í∞Ä / (1 + dropRate)
                    // ÌòÑÏû¨Í∞Ä = Ï†ÄÏ†ê * (1 + recRate)   -> Ï†ÄÏ†ê = ÌòÑÏû¨Í∞Ä / (1 + recRate)
                    const highPrice = price / (1 + dropRate);
                    const lowPrice = price / (1 + recRate);
                    
                    // ÌòÑÏû¨ ÏúÑÏπò ÌçºÏÑºÌä∏ (0% = Ï†ÄÏ†ê, 100% = Í≥†Ï†ê)
                    // Í≥µÏãù: (ÌòÑÏû¨Í∞Ä - Ï†ÄÏ†ê) / (Í≥†Ï†ê - Ï†ÄÏ†ê) * 100
                    let posPercent = ((price - lowPrice) / (highPrice - lowPrice)) * 100;
                    posPercent = Math.max(0, Math.min(100, posPercent)); // 0~100 Ï†úÌïú

                    const html = `
                        <div class="card elite-card p-4 flex flex-col justify-between h-full cursor-pointer hover:scale-105 transition-transform" onclick="document.getElementById('row-${stock.ticker}').scrollIntoView({behavior: 'smooth'}); toggleRow('${stock.ticker}')">
                            <div class="elite-badge">TOP ${idx + 1}</div>
                            <div>
                                <div class="text-2xl font-bold text-white mb-1">${stock.ticker}</div>
                                <div class="text-sm font-mono text-gray-400">$${price.toFixed(2)}</div>
                            </div>
                            
                            <div class="mt-4">
                                <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                    <span>Ï†ÄÏ†ê $${lowPrice.toFixed(1)}</span>
                                    <span>Í≥†Ï†ê $${highPrice.toFixed(1)}</span>
                                </div>
                                <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden relative">
                                    <div class="absolute bg-green-500 h-full rounded-full" style="width: ${posPercent}%"></div>
                                </div>
                                <div class="text-right mt-1">
                                    <span class="text-xs font-bold text-green-400">+${(recRate * 100).toFixed(1)}% Î∞òÎì±Ï§ë</span>
                                </div>
                            </div>
                        </div>
                    `;
                    eliteContainer.insertAdjacentHTML('beforeend', html);
                });


                // --- 2. Ï†ÑÏ≤¥ Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ (ÏÉàÎ°úÏö¥ ÏãúÍ∞ÅÌôî Ï†ÅÏö©) ---
                const listContainer = document.getElementById('candidate-list');
                listContainer.innerHTML = '';

                candidates.forEach((stock, index) => {
                    const isReady = stock.evidence.s4_tag === 'READY';
                    const tagClass = isReady ? 'text-green-400 border-green-500/30 bg-green-500/10' : 'text-blue-400 border-blue-500/30 bg-blue-500/10';
                    
                    // Í∞ÄÍ≤© Ïó≠ÏÇ∞ Î°úÏßÅ (ÏúÑÏôÄ ÎèôÏùº)
                    const price = stock.price;
                    const highPrice = price / (1 + stock.metrics.drop_rate);
                    const lowPrice = price / (1 + stock.metrics.rec_rate);
                    
                    // ÏúÑÏπò Í≥ÑÏÇ∞ (Range Position)
                    let posPercent = ((price - lowPrice) / (highPrice - lowPrice)) * 100;
                    posPercent = Math.max(5, Math.min(95, posPercent)); // ÎßàÏª§Í∞Ä Î∞ñÏúºÎ°ú Ïïà ÎÇòÍ∞ÄÍ≤å Ï°∞Ï†ï

                    // Îâ¥Ïä§ ÏöîÏïΩ
                    let newsTitle = stock.context.length > 60 ? stock.context.substring(0, 60) + "..." : stock.context;

                    const itemHTML = `
                        <div id="row-${stock.ticker}" class="card overflow-hidden">
                            <div class="p-4 cursor-pointer" onclick="toggleRow('${stock.ticker}')">
                                <div class="flex flex-col md:flex-row items-center gap-4 md:gap-8">
                                    
                                    <div class="w-full md:w-24 flex items-center justify-between md:block">
                                        <div class="text-xl font-bold text-white">${stock.ticker}</div>
                                        <div class="text-sm font-mono text-gray-400">$${price}</div>
                                    </div>

                                    <div class="w-full flex-1">
                                        <div class="range-track">
                                            <div class="current-marker" style="left: ${posPercent}%"></div>
                                            
                                            <div class="price-label current" style="left: ${posPercent}%">$${price}</div>
                                            <div class="price-label low">‚ñº Î∞îÎã• $${lowPrice.toFixed(1)}</div>
                                            <div class="price-label high">Í≥†Ï†ê $${highPrice.toFixed(1)} ‚ñ≤</div>
                                        </div>
                                    </div>

                                    <div class="w-full md:w-32 flex justify-between md:justify-end items-center mt-4 md:mt-0">
                                        <span class="px-2 py-1 rounded text-xs font-bold border ${tagClass} mr-3">${stock.evidence.s4_tag}</span>
                                        <i id="icon-${stock.ticker}" class="fa-solid fa-chevron-down text-gray-500 transition-transform"></i>
                                    </div>
                                </div>
                            </div>

                            <div id="detail-${stock.ticker}" class="hidden-row p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">üìä AI Strategy Analysis</h4>
                                        <div class="text-sm text-gray-300 leading-relaxed whitespace-pre-line">
                                            ${stock.evidence.analysis_kr || "Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"}
                                        </div>
                                        <div class="mt-4 text-xs text-gray-500">
                                            * Ïù¥ Ï¢ÖÎ™©Ïù¥ Îã§Ïãú Í≥†Ï†ê($${highPrice.toFixed(2)})ÍπåÏßÄ Í∞ÑÎã§Î©¥? 
                                            <span class="text-green-400 font-bold text-sm ml-1">
                                                +${((highPrice/price - 1)*100).toFixed(0)}% ÏàòÏùµ Í∞ÄÎä•ÏÑ±
                                            </span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">üì∞ Latest News</h4>
                                        <div class="bg-black/30 p-3 rounded border border-gray-800 text-sm text-gray-400 mb-2">
                                            ${stock.context}
                                        </div>
                                        <a href="https://www.google.com/search?q=${stock.ticker}+stock+news" target="_blank" class="text-xs text-blue-400 hover:underline">
                                            Íµ¨Í∏Ä Îâ¥Ïä§ Í≤ÄÏÉâ <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', itemHTML);
                });

            } catch (err) {
                console.error(err);
                document.getElementById('candidate-list').innerHTML = `<div class="p-10 text-center text-red-500">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë Ïò§Î•ò Î∞úÏÉù</div>`;
            }
        }

        function toggleRow(ticker) {
            const row = document.getElementById(`detail-${ticker}`);
            const icon = document.getElementById(`icon-${ticker}`);
            if (row.classList.contains('hidden-row')) {
                row.classList.remove('hidden-row');
                row.classList.add('expanded-row');
                icon.style.transform = 'rotate(180deg)';
            } else {
                row.classList.add('hidden-row');
                row.classList.remove('expanded-row');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        loadDashboard();
    </script>
</body>
</html>
