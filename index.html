<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pro | Command Center V4.0 Banana Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #0d1117; color: #e6edf3; }
        .container-tight { max-width: 1100px; margin: 0 auto; }
        
        .card { 
            background: #161b22; border: 1px solid #30363d; border-radius: 12px; transition: all 0.2s ease;
        }
        .card:hover { 
            border-color: #79c0ff; transform: translateY(-2px); background-color: #1c2128;
        }
        
        /* Elite 5 카드 및 차트 영역 */
        .elite-card { background: linear-gradient(135deg, #161b22 0%, #0d1117 100%); border: 1px solid #3fb950; position: relative; overflow: hidden; }
        .elite-badge { position: absolute; top: 0; right: 0; background: #3fb950; color: #000; font-weight: 800; font-size: 0.7rem; padding: 2px 10px; border-bottom-left-radius: 8px; }
        .chart-container { height: 40px; width: 100%; margin-top: 10px; }
        .chart-container svg { width: 100%; height: 100%; overflow: visible; }

        /* 메인 리스트 스타일 */
        .tag-ready { color: #3fb950; background: rgba(63, 185, 80, 0.15); border: 1px solid rgba(63, 185, 80, 0.4); }
        .tag-watch { color: #58a6ff; background: rgba(88, 166, 255, 0.15); border: 1px solid rgba(88, 166, 255, 0.4); }
        .hidden-row { display: none; }
        .expanded-row { background-color: #11141a; border-top: 1px dashed #30363d; }
        .txt-label { font-size: 0.7rem; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; }
    </style>
</head>
<body class="p-6 md:p-10">
    <div class="container-tight">
        <header class="flex justify-between items-center mb-10 border-b border-gray-800 pb-6">
            <h1 class="text-3xl font-extrabold text-white flex items-center">
                <i class="fa-solid fa-crosshairs text-green-500 mr-3"></i> Turnaround Sniper
                <span class="ml-3 text-xs bg-gray-800 text-gray-300 px-2 py-1 rounded border border-gray-700">V4.0 CHART</span>
            </h1>
            <div class="text-right">
                <div id="last-update" class="text-xs font-mono text-gray-500">Connecting...</div>
                <div class="text-xs text-green-500 font-bold mt-1"><i class="fa-solid fa-server mr-1"></i>System Active</div>
            </div>
        </header>

        <section class="mb-10">
            <div class="flex items-center space-x-2 mb-4">
                <i class="fa-solid fa-star text-yellow-500"></i>
                <h2 class="text-lg font-bold text-gray-200">Top 5 V-Shape Rebounds (3-Month View)</h2>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="elite-container">
                </div>
        </section>

        <main>
            <div class="flex items-center justify-between mb-4 px-2">
                <h3 class="text-md font-bold text-gray-300"><i class="fa-solid fa-list-ul mr-2"></i>Active Candidates</h3>
            </div>
            <div class="hidden md:grid grid-cols-12 gap-6 px-6 pb-2 text-xs font-bold text-gray-500 uppercase">
                <div class="col-span-3">Target Asset</div>
                <div class="col-span-4">3-Month Price Trend (Nano Chart)</div>
                <div class="col-span-5 text-right">Primary Context</div>
            </div>
            <div class="flex flex-col space-y-4" id="candidate-list">
                <div class="p-10 text-center text-gray-600">데이터를 불러오는 중입니다...</div>
            </div>
        </main>
    </div>

    <script>
        // [핵심 기술] 나노 바나나 차트 그리기 엔진 (SVG)
        function drawSparkline(data, color = '#3fb950') {
            if (!data || data.length < 2) return '<div class="text-xs text-gray-600 h-full flex items-center">No Data</div>';
            
            const width = 200; // SVG 내부 좌표계 너비
            const height = 50; // SVG 내부 좌표계 높이
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1; // 0으로 나누기 방지

            // 데이터를 SVG 좌표로 변환하는 함수
            const normalize = (val) => height - ((val - min) / range) * height;

            // 선 그리기 경로(Path) 생성
            let pathD = `M 0 ${normalize(data[0])} `;
            const stepX = width / (data.length - 1);
            data.slice(1).forEach((val, i) => {
                pathD += `L ${(i + 1) * stepX} ${normalize(val)} `;
            });

            // 그라데이션 채우기 영역 생성 (선 아래를 색칠)
            const fillD = `${pathD} L ${width} ${height} L 0 ${height} Z`;

            return `
                <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="grad-${color.replace('#','')}" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:0.4" />
                            <stop offset="100%" style="stop-color:${color};stop-opacity:0.0" />
                        </linearGradient>
                    </defs>
                    <path d="${fillD}" fill="url(#grad-${color.replace('#','')})" stroke="none" />
                    <path d="${pathD}" fill="none" stroke="${color}" stroke-width="2" stroke-linejoin="round" vector-effect="non-scaling-stroke"/>
                </svg>
            `;
        }

        async function loadDashboard() {
            try {
                const response = await fetch('data/data.json?t=' + Date.now());
                const data = await response.json();

                // 데이터 전처리 (수치 계산 및 히스토리 파싱)
                let candidates = data.candidates.map(c => {
                    // 문자열로 저장된 history를 다시 숫자 배열로 변환
                    let historyData = [];
                    try {
                        historyData = JSON.parse(c.history.replace(/'/g, '"')); # 작은따옴표를 큰따옴표로 바꿔서 JSON 파싱
                    } catch (e) { historyData = []; }

                    const highPrice = c.high_52w; // 이제 스캐너가 정확히 줌
                    const lowPrice = c.low_52w;
                    const upside = highPrice > 0 ? ((highPrice / c.price) - 1) * 100 : 0;

                    return { ...c, highPrice, lowPrice, upside, historyData };
                });

                // 정렬 (반등폭 순)
                let readyStocks = candidates.filter(c => c.evidence.s4_tag === 'READY');
                if (readyStocks.length < 5) readyStocks = [...readyStocks, ...candidates.filter(c => c.evidence.s4_tag === 'WATCH')];
                readyStocks.sort((a, b) => b.metrics.recovery_rate - a.metrics.recovery_rate);

                document.getElementById('last-update').innerText = `DATA: ${data.metadata.generated_at}`;

                // --- 1. Elite 5 + Nano Charts ---
                const eliteContainer = document.getElementById('elite-container');
                eliteContainer.innerHTML = '';
                readyStocks.slice(0, 5).forEach((stock, idx) => {
                    const recPercent = (stock.metrics.recovery_rate * 100).toFixed(1);
                    // 차트 그리기 함수 호출!
                    const chartSVG = drawSparkline(stock.historyData, '#3fb950');

                    const html = `
                        <div class="card elite-card p-4 cursor-pointer hover:scale-105 transition-transform" onclick="document.getElementById('row-${stock.ticker}').scrollIntoView({behavior: 'smooth'}); toggleRow('${stock.ticker}')">
                            <div class="elite-badge">#${idx + 1}</div>
                            <div class="text-2xl font-bold text-white mb-1">${stock.ticker}</div>
                            <div class="text-xs text-green-400 font-bold">+${recPercent}% Rebound</div>
                            <div class="chart-container">
                                ${chartSVG}
                            </div>
                        </div>
                    `;
                    eliteContainer.insertAdjacentHTML('beforeend', html);
                });

                // --- 2. 메인 리스트 + Nano Charts ---
                const listContainer = document.getElementById('candidate-list');
                listContainer.innerHTML = '';

                candidates.forEach(stock => {
                    const isReady = stock.evidence.s4_tag === 'READY';
                    const tagClass = isReady ? 'text-green-400 border-green-500/30' : 'text-blue-400 border-blue-500/30';
                    const chartColor = isReady ? '#3fb950' : '#58a6ff';
                    
                    // 차트 그리기 함수 호출!
                    const chartSVG = drawSparkline(stock.historyData, chartColor);
                    
                    let newsText = stock.context || "";
                    if (newsText.length > 70) newsText = newsText.substring(0, 70) + "...";

                    const itemHTML = `
                        <div id="row-${stock.ticker}" class="card group">
                            <div class="p-5 cursor-pointer grid grid-cols-1 md:grid-cols-12 gap-6 items-center" onclick="toggleRow('${stock.ticker}')">
                                <div class="md:col-span-3 flex items-center space-x-4">
                                    <div class="w-12 h-12 rounded-lg bg-gray-800 flex items-center justify-center text-xl font-bold text-white border border-gray-700">
                                        ${stock.ticker[0]}
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white leading-none">${stock.ticker}</div>
                                        <div class="text-sm font-mono text-gray-400 mt-1">$${stock.price.toFixed(2)}</div>
                                    </div>
                                    <span class="ml-2 px-2 py-0.5 rounded text-[10px] font-bold border ${tagClass}">${stock.evidence.s4_tag}</span>
                                </div>

                                <div class="md:col-span-4 h-12 flex items-center">
                                    <div class="chart-container h-full w-full" style="margin-top: 0;">
                                        ${chartSVG}
                                    </div>
                                </div>

                                <div class="md:col-span-5 text-right pl-4 border-l border-gray-800 hidden md:block">
                                    <div class="text-xs text-gray-300 group-hover:text-white transition-colors line-clamp-2">${newsText}</div>
                                </div>
                            </div>
                            <div id="detail-${stock.ticker}" class="hidden-row p-8">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="txt-label mb-2"><i class="fa-solid fa-chart-line mr-1"></i> Strategy Insight</h4>
                                        <div class="text-sm text-gray-300 leading-7 p-4 bg-gray-900 rounded border border-gray-800">
                                            ${stock.evidence.analysis_kr}
                                            <div class="mt-4 pt-4 border-t border-gray-800 flex justify-between items-center">
                                                <span class="text-xs text-gray-500">전고점($${stock.highPrice.toFixed(2)}) 복귀 시</span>
                                                <span class="text-lg font-bold text-green-400">+${stock.upside.toFixed(0)}% 수익 가능</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="txt-label mb-2"><i class="fa-regular fa-newspaper mr-1"></i> News Source</h4>
                                        <div class="text-sm text-gray-400 mb-2">"${stock.context}"</div>
                                        <a href="https://www.google.com/search?q=${stock.ticker}+stock+news" target="_blank" class="text-blue-400 hover:underline text-xs">Google Search &rarr;</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', itemHTML);
                });

            } catch (err) {
                console.error(err);
                document.getElementById('candidate-list').innerHTML = `<div class="p-10 text-center text-red-500">오류: 데이터 형식이 올바르지 않습니다. 스캔을 다시 실행해주세요.</div>`;
            }
        }

        function toggleRow(ticker) {
            const row = document.getElementById(`detail-${ticker}`);
            row.classList.toggle('hidden-row');
        }

        loadDashboard();
    </script>
</body>
</html>
